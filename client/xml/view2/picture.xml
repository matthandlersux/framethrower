<f:template name="testTemplate"
	xmlns:f="http://www.worldmerge.com/2008/xsl"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
	
	<f:param name="focus" type="Object" />
	<f:param name="width" type="Number" />
	<f:param name="height" type="Number" />
	
	<f:thunk with-template="$print">
		<f:with-param name="focus" select="$focus" />
		<f:with-param name="transform"><f:transform /></f:with-param>
	</f:thunk>
	

	
	<f:template name="print">
		<f:param name="focus" type="Object" />
		<f:param name="transform" type="XML" />
		
		<f:derive name="asPicture" d="Object~X.picture focus" />
		<f:derive name="asCons" d="Object~Cons focus" />

		<f:each select="$asPicture">
			<f:thunk with-template="$printPicture">
				<f:with-param name="picture" select="$asPicture" />
				<f:with-param name="transform" select="$transform" />
			</f:thunk>
		</f:each>

	</f:template>
	
	<!-- <f:template name="printCons">
		<f:param name="picture" type="Cons" />
		<f:param name="transform" type="XML" />
		<f:derive name="crop" d="" />
		<f:derive name="pic" d="" />
	</f:template> -->
	
	<f:template name="printPicture">
		<f:param name="picture" type="X.picture" />
		<f:param name="transform" type="XML" />
		
		<f:derive name="url" d="X.picture:url picture" />
		<f:derive name="pw" d="X.picture:width picture" />
		<f:derive name="ph" d="X.picture:height picture" />
		
		<f:each select="$url"><f:each select="$pw"><f:each select="$ph">
		
			<xsl:variable name="ratio" select="$width/@value div $height/@value" />
			<xsl:variable name="pratio" select="$pw/@value div $ph/@value" />
		
			<xsl:variable name="mult">
				<xsl:choose>
					<xsl:when test="$ratio &gt; $pratio">
						<xsl:value-of select="$height/@value div $ph/@value" />
					</xsl:when>
					<xsl:otherwise>
						<xsl:value-of select="$width/@value div $pw/@value" />
					</xsl:otherwise>
				</xsl:choose>
			</xsl:variable>
		
			<xsl:variable name="w" select="round($mult * $pw/@value)" />
			<xsl:variable name="h" select="round($mult * $ph/@value)" />
		
			<html:img src="{$url/@value}" width="{$w}" height="{$h}" />
		
		</f:each></f:each></f:each>
	</f:template>
	
</f:template>