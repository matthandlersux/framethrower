<f:template name="testTemplate"
	xmlns:f="http://www.worldmerge.com/2008/xsl"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
	
	<f:param name="focus" type="UI.consIP" />
	<f:param name="expectedType" type="Object" />

	<f:derive name="object" d="UI.consIP:object focus" />
	<f:derive name="left" d="UI.consIP:left focus" />
	<f:derive name="right" d="UI.consIP:right focus" />
	<!-- <f:derive name="asConsIP" d="UI.objectIP~UI.consIP focus" /> -->
	
	<f:derive name="infonType" d="shared.type.infon" />
	<f:derive name="typeDisplay" d="X.prefs:typeColors shared.globalPrefs" />
	<f:derive name="typeName" d="getName expectedType" />

	<f:include url="/xml/util/typeColor.xml" />

	
	<xsl:variable name="expectInfon" select="$expectedType/@name = $infonType/@name" />
	<xsl:variable name="empty" select="not($object/*) and not($left/*)" />
	
	<xsl:choose>
		<xsl:when test="$expectInfon">
			<html:div>
				<f:on event="click" with-action="$showRelationPopup">
					<f:with-param-browser name="x" prop="mouseX" />
					<f:with-param-browser name="y" prop="mouseY" />
				</f:on>
				<xsl:choose>
					<xsl:when test="$empty">
						<html:div class="infon"><html:div class="infonCell">
							<html:button>Select Relation</html:button>
						</html:div></html:div>
					</xsl:when>
					<xsl:otherwise>
						<f:thunk with-template="$printCons" />
					</xsl:otherwise>
				</xsl:choose>
			</html:div>
		</xsl:when>
		<xsl:otherwise>
			<html:div>
				<f:on event="click" with-action="$showObjectPopup">
					<f:with-param-browser name="x" prop="mouseX" />
					<f:with-param-browser name="y" prop="mouseY" />
				</f:on>
				<f:on event="dragEnd" with-action="$dropObject" />
				<xsl:choose>
					<xsl:when test="$empty">
						<xsl:variable name="color">
							<xsl:call-template name="typeColor">
								<xsl:with-param name="typeNames" select="$expectedType/@name" />
								<xsl:with-param name="typeDisplay" select="$typeDisplay" />
							</xsl:call-template>
						</xsl:variable>
						
						<html:div class="objectDrop">
							<xsl:attribute name="style">
								border-color: <xsl:value-of select="$color" />;
								color: <xsl:value-of select="$color" />;
							</xsl:attribute>
							<xsl:value-of select="$typeName/*/@value" />
						</html:div>
					</xsl:when>
					<xsl:otherwise>
						<f:each select="$object">
							<f:thunk url="viewNormal.xml">
								<f:with-param name="focus" select="$object" />
							</f:thunk>
						</f:each>
						<f:each select="$left">
							<f:thunk with-template="$printCons" />
						</f:each>
					</xsl:otherwise>
				</xsl:choose>
			</html:div>
		</xsl:otherwise>
	</xsl:choose>
	
	<f:include url="/xml/util/uiActions.xml" />
	
	<f:template name="wrapInContext">
		<html:div>
			<f:on event="click" with-action="$wrap" />
			<html:button>Wrap in context</html:button>
		</html:div>
		<f:action name="wrap">
			<f:derive name="sharedIn" d="shared.in" />
			<f:create type="UI.consIP" name="temp" />
			<f:each select="$object">
				<f:intact object="$temp" action="add" property="object" key="$object" />
			</f:each>
			<f:each select="$left"><f:each select="$right">
				<f:intact object="$temp" action="add" property="left" key="$left" />
				<f:intact object="$temp" action="add" property="right" key="$right" />
			</f:each></f:each>
			
			<f:create type="UI.consIP" name="in" />
			<f:intact object="$in" action="add" property="object" key="$sharedIn" />
			
			<f:create type="UI.consIP" name="sit" />
			<f:create type="UI.consIP" name="cons" />
			<f:intact object="$cons" action="add" property="left" key="$in" />
			<f:intact object="$cons" action="add" property="right" key="$sit" />
			
			<f:intact object="$focus" action="add" property="left" key="$cons" />
			<f:intact object="$focus" action="add" property="right" key="$temp" />
			<f:intact object="$focus" action="remove" property="object" />
			
			<f:perform with-action="$hidePopup" />
		</f:action>
	</f:template>
	
	<f:template name="newRelation">
		<html:div>
			<f:on event="click" with-action="$showNewRelationPopup">
				<f:with-param-browser name="x" prop="mouseX" />
				<f:with-param-browser name="y" prop="mouseY" />
			</f:on>
			<html:button>New Relation</html:button>
		</html:div>
		<f:template name="newRelationPopup">
			<f:derive name="relationCreator" d="ui.relationCreator" />
			<f:thunk url="../relationCreator/relationCreator.xml">
				<f:with-param name="relationCreator" select="$relationCreator" />
			</f:thunk>
		</f:template>
		<f:action name="showNewRelationPopup">
			<f:param name="x" type="Number" />
			<f:param name="y" type="Number" />
			<f:perform with-action="$showPopup">
				<f:with-param name="display"><display x="{$x/@value}" y="{$y/@value}" width="400" height="220" /></f:with-param>
				<f:with-param name="content" select="$newRelationPopup" />
			</f:perform>
		</f:action>
	</f:template>
	
	
	
	<f:template name="relationPopup">
		<f:derive name="relations" d="filterRelations (getAllIn shared.ont)" />
		
		<f:thunk with-template="$wrapInContext" />
		<f:thunk with-template="$newRelation" />
		
		<f:each select="$relations" key="relation">
			<html:div class="entry">
				<f:on event="click" with-action="$selectRelation">
					<f:with-param name="relation" select="$relation" />
				</f:on>
				
				<f:thunk url="relation.xml">
					<f:with-param name="focus" select="$relation" />
				</f:thunk>
			</html:div>
			<f:thunk with-template="$selectRelation">
				<f:with-param name="relation" select="$relation" />
			</f:thunk>
		</f:each>
		<f:action name="selectRelation">
			<f:param name="relation" type="Object" />
			<f:derive name="argCount" d="(mapSet (compose (compose length keys) getRelationTypeComponents)) (bindUnitSet Object~Cons (getTypes relation))" />
			
			<!-- TODO: this is super confusing.. rewrite -->
			
			<f:intact object="$focus" action="remove" property="object" />
			<f:intact object="$focus" action="remove" property="left" />
			<f:intact object="$focus" action="remove" property="right" />
			
			<f:create name="left" type="UI.consIP" />
			<f:intact object="$left" action="add" property="object" key="$relation" />
			
			<xsl:variable name="recursions" select="$argCount/*[1]/*/@value - 1" />
			
			<xsl:choose>
				<xsl:when test="$recursions &gt; 0">
					<xsl:call-template name="makeConsIP">
						<xsl:with-param name="num" select="$recursions" />
						<xsl:with-param name="left" select="$left" />
					</xsl:call-template>

					<f:intact action="add" property="left" object="$focus">
						<f:with-param name="key"><f:var name="c1" /></f:with-param>
					</f:intact>

					<f:create type="UI.consIP" name="o0" />
					<f:intact action="add" property="right" object="$focus" key="$o0" />
				</xsl:when>
				<xsl:when test="$recursions = 0">
					<f:intact action="add" property="left" object="$focus" key="$left" />

					<f:create type="UI.consIP" name="o0" />
					<f:intact action="add" property="right" object="$focus" key="$o0" />
				</xsl:when>
				<xsl:otherwise>
					<f:intact action="add" property="object" object="$focus" key="$relation" />
				</xsl:otherwise>
			</xsl:choose>

				
			<f:perform with-action="$hidePopup" />
			
			<xsl:template name="makeConsIP">
				<xsl:param name="num" />
				<xsl:param name="left" />
				
				<f:create type="UI.consIP" name="o{$num}" />
				<f:create type="UI.consIP" name="c{$num}" />
				
				<f:intact action="add" property="left" key="$left">
					<f:with-param name="object"><f:var name="c{$num}" /></f:with-param>
				</f:intact>
				<f:intact action="add" property="right">
					<f:with-param name="object"><f:var name="c{$num}" /></f:with-param>
					<f:with-param name="key"><f:var name="o{$num}" /></f:with-param>
				</f:intact>
				
				<xsl:if test="$num &gt; 1">
					<xsl:call-template name="makeConsIP">
						<xsl:with-param name="num" select="$num - 1" />
						<xsl:with-param name="left">
							<f:var name="c{$num}" />
						</xsl:with-param>
					</xsl:call-template>
				</xsl:if>
			</xsl:template>
			
			
		</f:action>
	</f:template>
	<f:action name="showRelationPopup">
		<f:param name="x" type="Number" />
		<f:param name="y" type="Number" />
		
		<f:perform with-action="$showPopup">
			<f:with-param name="display"><display x="{$x/@value}" y="{$y/@value}" width="260" height="500" /></f:with-param>
			<f:with-param name="content" select="$relationPopup" />
		</f:perform>
	</f:action>
	
	<f:template name="objectPopup">
		<f:derive name="objects" d="getObjectsOfTypeRecursive expectedType" />
		
		<f:thunk with-template="$wrapInContext" />
		
		<f:each select="$objects" key="object">
			<html:div class="entry">
				<f:on event="click" with-action="$selectObject">
					<f:with-param name="object" select="$object" />
				</f:on>
				<f:thunk url="object.xml">
					<f:with-param name="focus" select="$object" />
				</f:thunk>
			</html:div>
		</f:each>
		<f:action name="selectObject">
			<f:param name="object" type="Object" />
			
			<f:intact action="add" property="object" object="$focus" key="$object" />
				
			<f:perform with-action="$hidePopup" />
		</f:action>
	</f:template>
	<f:action name="showObjectPopup">
		<f:param name="x" type="Number" />
		<f:param name="y" type="Number" />
		
		<f:perform with-action="$showPopup">
			<f:with-param name="display"><display x="{$x/@value}" y="{$y/@value}" width="260" height="500" /></f:with-param>
			<f:with-param name="content" select="$objectPopup" />
		</f:perform>
	</f:action>
	

	
	<f:action name="dropObject">
		<f:derive name="droppedObject" d="bindUnit (compose returnFutureUnit UI.dragging:object) (UI.main:dragging ui.main)" />
		
		<f:each select="$droppedObject">
			<f:intact object="$focus" action="add" property="object" key="$droppedObject" />
			<f:perform with-action="$stopDragging" />
		</f:each>
		
		<f:intact object="$focus" action="remove" property="left" />
		<f:intact object="$focus" action="remove" property="right" />
	</f:action>

	







	<f:template name="printCons">
		<f:derive name="infonArgs" d="getInfonIPArguments focus" />
		<f:derive name="relationSet" d="bindUnitSet UI.consIP:object (getInfonIPRelations focus)" />
			
		<f:derive name="polyA" d="shared.type.poly.a" />
		
		<xsl:if test="$relationSet/*">
			<f:thunk with-template="$helper">
				<f:with-param name="relation" select="$relationSet/*[1]" />
			</f:thunk>
		</xsl:if>
		
		
		<f:template name="helper">
			<f:param name="relation" type="Object" />
			
			<f:derive name="template" d="getRelationTemplate relation" />
			<f:derive name="rtInputs" d="mapSet getRelationTypeInputs (bindUnitSet Object~Cons (getTypes relation))" />
			
			<xsl:variable name="color">
				<xsl:call-template name="typeColor">
					<xsl:with-param name="typeNames" select="$expectedType/@name" />
					<xsl:with-param name="typeDisplay" select="$typeDisplay" />
				</xsl:call-template>
			</xsl:variable>
			
		
			<xsl:variable name="rt" select="$template/f:literal/f:relationTemplate" />
			<xsl:if test="$rt">
				<html:span>
					<xsl:call-template name="print">
						<xsl:with-param name="relationTemplate" select="$rt" />
						<xsl:with-param name="infonArgs" select="$infonArgs" />
						<xsl:with-param name="argTemplate" select="$printArg" />
						<xsl:with-param name="color" select="$color" />
					</xsl:call-template>
				</html:span>
			</xsl:if>
		
			<f:template name="printArg">
				<f:param name="focus" type="UI.consIP" />
				<f:param name="num" type="Number" />
			
				<xsl:variable name="t" select="$rtInputs/f:map[1]/f:entry[position() = $num/@value]/f:value/*/*" />
				<xsl:if test="$t">
					<xsl:choose>
						<xsl:when test="$t/@name = $polyA/@name">
							<f:thunk url="infonIP.xml">
								<f:with-param name="focus" select="$focus" />
								<f:with-param name="expectedType" select="$expectedType" />
							</f:thunk>
						</xsl:when>
						<xsl:otherwise>
							<f:thunk url="infonIP.xml">
								<f:with-param name="focus" select="$focus" />
								<f:with-param name="expectedType" select="$t" />
							</f:thunk>
						</xsl:otherwise>
					</xsl:choose>
				</xsl:if>
			</f:template>
		
		</f:template>
		
		<f:include url="util/printInfon.xml" />
	
		<f:include url="/xml/debug/prettyPrint.xml" />
		
	</f:template>
	

</f:template>