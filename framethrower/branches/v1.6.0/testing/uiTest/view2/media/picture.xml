<f:template name="testTemplate"
	xmlns:f="http://www.worldmerge.com/2008/xsl"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
	
	<f:param name="focus" type="X.picture" />
	
	<f:param name="transform" type="XML" />
	
	<f:derive name="url" d="X.picture:url focus" />
	<f:derive name="pw" d="X.picture:width focus" />
	<f:derive name="ph" d="X.picture:height focus" />
	
	<f:each select="$url"><f:each select="$pw"><f:each select="$ph">
	
		<xsl:variable name="width" select="$transform/f:transform/@width" />
		<xsl:variable name="height" select="$transform/f:transform/@height" />
	
		<xsl:variable name="ratio" select="$width div $height" />
		<xsl:variable name="pratio" select="$pw/@value div $ph/@value" />
	
		<xsl:variable name="mult">
			<xsl:choose>
				<xsl:when test="$ratio &gt; $pratio">
					<xsl:value-of select="$height div $ph/@value" />
				</xsl:when>
				<xsl:otherwise>
					<xsl:value-of select="$width div $pw/@value" />
				</xsl:otherwise>
			</xsl:choose>
		</xsl:variable>
	
		<xsl:variable name="w" select="round($mult * $pw/@value)" />
		<xsl:variable name="h" select="round($mult * $ph/@value)" />
	
		<html:img src="http://media.eversplosion.com/crop.php?file={$url/@value}&amp;width={$w}&amp;height={$h}" width="{$w}" height="{$h}" />
	
	</f:each></f:each></f:each>
	
</f:template>