<f:template name="testTemplate"
	xmlns:f="http://www.worldmerge.com/2008/xsl"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">
	
	<f:param name="popup" type="UI.popup" />
	<f:param name="width" type="Number" />
	<f:param name="height" type="Number" />
	
	
	<f:derive name="px" d="UI.popup:x popup" />
	<f:derive name="py" d="UI.popup:y popup" />
	<f:derive name="pwidth" d="UI.popup:width popup" /> <!-- these aren't actually used anymore -->
	<f:derive name="pheight" d="UI.popup:height popup" /> <!-- these aren't actually used anymore -->
	<f:derive name="content" d="UI.popup:content popup" />


	<xsl:template name="min">
		<xsl:param name="n1" /><xsl:param name="n2" />
		<xsl:choose>
			<xsl:when test="$n1 &lt; $n2"><xsl:value-of select="$n1" /></xsl:when>
			<xsl:otherwise><xsl:value-of select="$n2" /></xsl:otherwise>
		</xsl:choose>
	</xsl:template>
	

	<f:each select="$px"><f:each select="$py"><f:each select="$pwidth"><f:each select="$pheight"><f:each select="$content">
		
		<xsl:variable name="w">
			<xsl:call-template name="min">
				<xsl:with-param name="n1" select="$pwidth/@value" />
				<xsl:with-param name="n2" select="floor($width/@value div 2)" />
			</xsl:call-template>
		</xsl:variable>
		<xsl:variable name="h">
			<xsl:call-template name="min">
				<xsl:with-param name="n1" select="$pheight/@value" />
				<xsl:with-param name="n2" select="floor($height/@value div 2)" />
			</xsl:call-template>
		</xsl:variable>
		
		<!-- The following works the way the mac context menu seems to work -->
		
		<xsl:variable name="left">
			<xsl:choose>
				<xsl:when test="$px/@value + $w &gt; $width/@value">
					<xsl:value-of select="$width/@value - $w" />
				</xsl:when>
				<xsl:otherwise>
					<xsl:value-of select="$px/@value" />
				</xsl:otherwise>
			</xsl:choose>
		</xsl:variable>

		<xsl:variable name="top">
			<xsl:choose>
				<xsl:when test="$py/@value + $h &gt; $height/@value">
					<xsl:value-of select="$py/@value - $h" />
				</xsl:when>
				<xsl:otherwise>
					<xsl:value-of select="$py/@value" />
				</xsl:otherwise>
			</xsl:choose>
		</xsl:variable>

		<html:div class="popup">
			<xsl:call-template name="style">
				<xsl:with-param name="left" select="$left" />
				<xsl:with-param name="top" select="$top" />
				<xsl:with-param name="width" select="$w" />
				<xsl:with-param name="height" select="$h" />
			</xsl:call-template>

			<f:thunk with-template="$content" />
		</html:div>
	</f:each></f:each></f:each></f:each></f:each>
	
	<f:include url="/xml/util/style.xml" />
</f:template>