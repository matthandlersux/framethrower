<f:transaction
	xmlns:f="http://www.filmsfolded.com/xsl/ui"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

	<f:param name="arg1"/>
	<f:param name="arg2"/>
	
	<f:derived name="arg1Anchor" from="arg1">
		<get what="involves" />
		<filter>
			<get what="relation" />
			<equals>
				<start predef="corresponds" />
			</equals>
		</filter>
		<foreach type="kernel.ob">
			<get what="arcs" />
			<getkey key="'anchor'" />
		</foreach>
		<takeone />
	</f:derived>
	
	<f:derived name="arg2Anchor" from="arg2">
		<get what="involves" />
		<filter>
			<get what="relation" />
			<equals>
				<start predef="corresponds" />
			</equals>
		</filter>
		<foreach type="kernel.ob">
			<get what="arcs" />
			<getkey key="'anchor'" />
		</foreach>
		<takeone />
	</f:derived>
	
	<xsl:template>
		<transaction>
			<xsl:choose>
				<xsl:when test="$arg1Anchor">
					<xsl:choose>
						<xsl:when test="$arg2Anchor">
							<!-- MERGE -->
							<!-- TODO: Add Merge Code -->
						</xsl:when>
						<xsl:otherwise>
							<!-- Point arg2 at arg1Anchor -->
							<f:perform url="makeInfon.xml">
								<f:with-param name="parentSituation" value-predef="ont" />
								<f:with-param name="relation" value-predef="corresponds"/>
								<f:with-param name="arcs">
									<f:assoc>
										<f:pair>
											<f:key><f:string value="anchor" /></f:key>
											<f:value><xsl:copy-of select="$arg1Anchor" /></f:value>
										</f:pair>
										<f:pair>
											<f:key><f:string value="corresponder" /></f:key>
											<f:value><xsl:copy-of select="$arg2" /></f:value>
										</f:pair>
									</f:assoc>
								</f:with-param>
							</f:perform>
						</xsl:otherwise>
					</xsl:choose>
				</xsl:when>
				<xsl:otherwise>
					<xsl:choose>
						<xsl:when test="$arg2Anchor">
							<!-- Point arg1 at arg2Anchor -->
							<f:perform url="makeInfon.xml">
								<f:with-param name="parentSituation" value-predef="ont" />
								<f:with-param name="relation" value-predef="corresponds"/>
								<f:with-param name="arcs">
									<f:assoc>
										<f:pair>
											<f:key><f:string value="anchor" /></f:key>
											<f:value><xsl:copy-of select="$arg2Anchor" /></f:value>
										</f:pair>
										<f:pair>
											<f:key><f:string value="corresponder" /></f:key>
											<f:value><xsl:copy-of select="$arg1" /></f:value>
										</f:pair>
									</f:assoc>
								</f:with-param>
							</f:perform>
						</xsl:when>
						<xsl:otherwise>
							<!-- Create new Anchor -->
							<f:perform url="makeIndividual.xml" prefix="anchor">
								<f:with-param name="parentSituation" value-predef="ont" />
							</f:perform>
							<!-- Point arg1 at new Anchor -->
							<f:perform url="makeInfon.xml">
								<f:with-param name="parentSituation" value-predef="ont" />
								<f:with-param name="relation" value-predef="corresponds"/>
								<f:with-param name="arcs">
									<f:assoc>
										<f:pair>
											<f:key><f:string value="anchor" /></f:key>
											<f:value><f:ob var="anchor.o" /></f:value>
										</f:pair>
										<f:pair>
											<f:key><f:string value="corresponder" /></f:key>
											<f:value><xsl:copy-of select="$arg1" /></f:value>
										</f:pair>
									</f:assoc>
								</f:with-param>
							</f:perform>
							<!-- Point arg2 at new Anchor -->
							<f:perform url="makeInfon.xml">
								<f:with-param name="parentSituation" value-predef="ont" />
								<f:with-param name="relation" value-predef="corresponds"/>
								<f:with-param name="arcs">
									<f:assoc>
										<f:pair>
											<f:key><f:string value="anchor" /></f:key>
											<f:value><f:ob var="anchor.o" /></f:value>
										</f:pair>
										<f:pair>
											<f:key><f:string value="corresponder" /></f:key>
											<f:value><xsl:copy-of select="$arg2" /></f:value>
										</f:pair>
									</f:assoc>
								</f:with-param>
							</f:perform>							
						</xsl:otherwise>
					</xsl:choose>
				</xsl:otherwise>
			</xsl:choose>
		</transaction>
	</xsl:template>
</f:transaction>