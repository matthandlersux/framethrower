<f:function
	xmlns:f="http://www.filmsfolded.com/xsl/ui"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">

	<f:param name="zui" />
	<f:param name="parentZui" />
	<f:param name="width" />
	<f:param name="height" />
	
	<f:derived name="focus" from="zui">
		<get what="focus" />
	</f:derived>
	<f:derived name="properties" from="zui">
		<get what="properties" />
	</f:derived>
	
	<xsl:template>
		<xsl:variable name="titleBarHeight" select="23" />
		<xsl:variable name="childrenSidebarExpandedWidth" select="240" />
		<xsl:variable name="openingPadding" select="6" />
		
		<html:div class="zui">
			<html:div class="zuiTitle" left="0" top="0" width="{$width/@value}" height="{$titleBarHeight}">
				<f:thunk url="printContent.xml">
					<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
				</f:thunk>
				
				<html:span style="margin-left:20px;">
					<f:button name="situationView" />
					Situation View
				</html:span>
				|
				<html:span>
					<f:button name="objectView" />
					Object View
				</html:span>
			</html:div>
			
			<xsl:choose>
				<xsl:when test="$properties/@view='situation'">
					<html:div class="zuiChildrenSidebar" left="0" top="{$titleBarHeight}" width="{$childrenSidebarExpandedWidth}" height="{$height/@value - $titleBarHeight}">
						<f:thunk name="printChildren">
							<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
							<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
						</f:thunk>
					</html:div>

					<xsl:variable name="openingWidth" select="$width/@value - $childrenSidebarExpandedWidth - $openingPadding * 2" />
					<xsl:variable name="openingHeight" select="$height/@value - $titleBarHeight - $openingPadding * 2" />

					<html:div class="zuiOpening" left="{$childrenSidebarExpandedWidth + $openingPadding}" top="{$titleBarHeight + $openingPadding}" width="{$openingWidth}" height="{$openingHeight}">
						<f:thunk name="printOpenings">
							<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
							<f:with-param name="width"><f:number value="{$openingWidth}" /></f:with-param>
							<f:with-param name="height"><f:number value="{$openingHeight}" /></f:with-param>
						</f:thunk>
					</html:div>

					<html:div style="clear:both" />
				</xsl:when>
				<xsl:otherwise>
					<html:div left="0" top="{$titleBarHeight}" width="{$width/@value}" height="{$height/@value - $titleBarHeight}">
						<f:thunk url="objectView.xml">
							<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:otherwise>
			</xsl:choose>

		</html:div>
	</xsl:template>
	
	
	<f:function name="printChildren">
		<f:param name="zui" />
		<f:param name="focus" />
		<f:derived name="children" from="focus">
			<get what="childObjects" />
		</f:derived>
		
		<xsl:template>
			<html:div>
				<xsl:for-each select="$children/*">
					<html:div>
						<f:binding url="bindings/child.xml">
							<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
							<f:with-param name="focus"><xsl:copy-of select="." /></f:with-param>
						</f:binding>
						<f:thunk url="printContent.xml">
							<f:with-param name="focus"><xsl:copy-of select="." /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:for-each>
			</html:div>
		</xsl:template>
	</f:function>
	
	<f:function name="printOpenings">
		<f:param name="zui" />
		<f:param name="width" />
		<f:param name="height" />
		<f:derived name="openZuis" from="zui">
			<get what="childZuis" />
		</f:derived>
		
		<xsl:template>
			<xsl:variable name="spacing" select="6" />
			
			<xsl:variable name="count" select="count($openZuis/*)" />
			<xsl:variable name="childWidth" select="floor(($width/@value - $spacing * ($count - 1)) div $count)" />
			
			<html:div>
				<xsl:for-each select="$openZuis/*">
					<html:div left="{count(preceding-sibling::*) * ($childWidth + $spacing)}">
						<f:thunk url="zui.xml">
							<f:with-param name="zui"><xsl:copy-of select="." /></f:with-param>
							<f:with-param name="parentZui"><xsl:copy-of select="$zui" /></f:with-param>
							<f:with-param name="width"><f:number value="{$childWidth}" /></f:with-param>
							<f:with-param name="height"><xsl:copy-of select="$height" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:for-each>
			</html:div>
		</xsl:template>
	</f:function>
	
	
	
</f:function>