<f:function
	xmlns:f="http://www.filmsfolded.com/xsl/ui"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">

	<f:param name="zui" />
	<f:param name="width" />
	<f:param name="height" />
	<f:param name="panelLayer" />
	
	<f:derived name="focus" from="zui">
		<get what="focus" />
	</f:derived>
	<f:derived name="focusType" from="focus">
		<gettype />
	</f:derived>
	<f:derived name="maximizedChild" from="zui">
		<get what="maximizedChild" />
	</f:derived>
	<f:derived name="properties" from="zui">
		<get what="properties" />
	</f:derived>
	
	<xsl:template>
		<xsl:variable name="w" select="$width/@value" />
		<xsl:variable name="h" select="$height/@value" />
		
		<xsl:variable name="titleBarHeight" select="29" />
		<xsl:variable name="childrenSidebarExpandedWidth" select="200" />
		
		<xsl:variable name="padding" select="7" />
		
		<html:div class="zui" left="0" top="0" width="{$width/@value}" height="{$height/@value}">
			<f:binding url="bindings/zui.xml">
				<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
				<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
			</f:binding>
			
			<!-- <html:div style="position:absolute">
				<f:thunk url="graphics/zuiPane.xml">
					<f:with-param name="width"><f:number value="{$w}" /></f:with-param>
					<f:with-param name="height"><f:number value="{$h}" /></f:with-param>
					<f:with-param name="border"><f:number value="{$padding}" /></f:with-param>
					<f:with-param name="titleBarHeight"><f:number value="{$titleBarHeight}" /></f:with-param>
					<xsl:variable name="paneColor">
						<xsl:choose>
							<xsl:when test="$focusType/@value='kernel.situation'">#eee</xsl:when>
							<xsl:otherwise>yellow</xsl:otherwise>
						</xsl:choose>
					</xsl:variable>
					<f:with-param name="color"><f:string value="{$paneColor}" /></f:with-param>
				</f:thunk>
			</html:div> -->
			
			<xsl:call-template name="paneBackground">
				<xsl:with-param name="color">
					<xsl:choose>
						<xsl:when test="$focusType/@value='kernel.situation'">#eee</xsl:when>
						<xsl:otherwise>yellow</xsl:otherwise>
					</xsl:choose>
				</xsl:with-param>
			</xsl:call-template>
			
			<html:div class="zuiTitle" left="0" top="0" width="{$width/@value}" height="{$titleBarHeight}">
				<f:button name="titlebar" />
				<f:thunk url="printContent.xml">
					<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
					<f:with-param name="style"><f:string value="inline" /></f:with-param>
				</f:thunk>
				<html:span style="margin-left:15px;" />
				<xsl:choose>
					<xsl:when test="$focusType/@value='kernel.situation'">
						<html:span>
							<f:button name="childrenSidebar" />
							Ch
						</html:span>
						|
						<xsl:choose>
							<xsl:when test="$properties/@view='situation'">
								<html:span>
									<f:button name="objectView" />
									OV
								</html:span>
								|
							</xsl:when>
							<xsl:otherwise>
								<html:span>
									<f:button name="situationView" />
									SV
								</html:span>
								|
							</xsl:otherwise>
						</xsl:choose>
					</xsl:when>
					<xsl:otherwise>

					</xsl:otherwise>
				</xsl:choose>
				<html:span>
					<f:button name="correspondSidebar" />
					Co
				</html:span>
				|
				<html:span>
					<f:button name="maximize" />
					Max
				</html:span>
				|
				<html:span>
					<f:button name="close" />
					X
				</html:span>
			</html:div>
			
			<xsl:choose>
				<xsl:when test="$maximizedChild">
					<xsl:variable name="openingWidth" select="$width/@value - $padding * 2" />
					<xsl:variable name="openingHeight" select="$height/@value - $titleBarHeight - $padding" />
					
					<html:div class="zuiOpening" left="{$padding}" top="{$titleBarHeight}" width="{$openingWidth}" height="{$openingHeight}">
						<html:div>
							<html:div left="0" top="0" width="{$openingWidth}" height="{$openingHeight}">
								<f:thunk url="zui.xml">
									<f:with-param name="zui"><xsl:copy-of select="$maximizedChild" /></f:with-param>
									<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
									<f:with-param name="width"><f:number value="{$openingWidth}" /></f:with-param>
									<f:with-param name="height"><f:number value="{$openingHeight}" /></f:with-param>
								</f:thunk>
							</html:div>
						</html:div>
					</html:div>
				</xsl:when>
				<xsl:when test="$properties/@view='situation' and $focusType/@value='kernel.situation'">
					<xsl:variable name="childrenSidebarWidth" select="$properties/@childrenSidebar * $childrenSidebarExpandedWidth" />
					<xsl:if test="$properties/@childrenSidebar='1'">
						<html:div class="zuiChildrenSidebar" left="{$padding}" top="{$titleBarHeight}" width="{$childrenSidebarWidth}" height="{$height/@value - $titleBarHeight - $padding - 26}">
							<f:thunk url="childrenSidebar.xml">
								<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="addButton" left="{$padding}" top="{$height/@value - $padding - 26}" width="{$childrenSidebarWidth}" height="26">
							<f:button name="addChild" />
						</html:div>
					</xsl:if>
					
					<xsl:variable name="correspondSidebarWidth" select="$properties/@correspondSidebar * $childrenSidebarExpandedWidth" />
					<xsl:if test="$properties/@correspondSidebar='1'">
						<html:div class="zuiChildrenSidebar" left="{$padding + $childrenSidebarWidth}" top="{$titleBarHeight}" width="{$correspondSidebarWidth}" height="{$height/@value - $titleBarHeight - $padding}">
							<f:thunk url="correspondSidebar.xml">
								<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="addButton" left="{$padding + $childrenSidebarWidth}" top="{$height/@value - $padding - 26}" width="{$correspondSidebarWidth}" height="26">
							<f:button name="addCorresponds" />
						</html:div>
					</xsl:if>

					<xsl:variable name="openingWidth" select="$width/@value - $childrenSidebarWidth - $correspondSidebarWidth - $padding * 2" />
					<xsl:variable name="openingHeight" select="$height/@value - $titleBarHeight - $padding" />
					
					<html:div class="zuiOpening" left="{$childrenSidebarWidth + $correspondSidebarWidth + $padding}" top="{$titleBarHeight}" width="{$openingWidth}" height="{$openingHeight}">
						<!--><f:thunk url="graphics/innerShadow.xml">
							<f:with-param name="width"><f:number value="{$openingWidth}" /></f:with-param>
							<f:with-param name="height"><f:number value="{$openingHeight}" /></f:with-param>
							<f:with-param name="offsetX"><f:number value="0" /></f:with-param>
							<f:with-param name="offsetY"><f:number value="5" /></f:with-param>
							<f:with-param name="blurAmount"><f:number value="10" /></f:with-param>
						</f:thunk>-->
						<f:thunk name="printOpenings">
							<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
							<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
							<f:with-param name="width"><f:number value="{$openingWidth}" /></f:with-param>
							<f:with-param name="height"><f:number value="{$openingHeight}" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:when>
				<xsl:otherwise>
					<xsl:variable name="correspondSidebarWidth" select="$properties/@correspondSidebar * $childrenSidebarExpandedWidth" />
					<xsl:if test="$properties/@correspondSidebar='1'">
						<html:div class="zuiChildrenSidebar" left="{$padding}" top="{$titleBarHeight}" width="{$correspondSidebarWidth}" height="{$height/@value - $titleBarHeight - $padding}">
							<f:thunk url="correspondSidebar.xml">
								<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="addButton" left="{$padding}" top="{$height/@value - $padding - 26}" width="{$correspondSidebarWidth}" height="26">
							<f:button name="addCorresponds" />
						</html:div>
					</xsl:if>					
					
					<xsl:variable name="openingWidth" select="$width/@value - $correspondSidebarWidth - $padding * 2" />
					
					<html:div left="{$correspondSidebarWidth + $padding}" top="{$titleBarHeight}" width="{$openingWidth}" height="{$height/@value - $titleBarHeight - $padding}">
						<f:thunk url="objectView.xml">
							<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:otherwise>
			</xsl:choose>

		</html:div>
	</xsl:template>
	
	<xsl:template name="paneBackground">
		<xsl:param name="color" />
		<html:div style="position:absolute; top:0px; left:0px; width:100%; height:100%;">
			
			
			<html:div class="paneBackgroundBR" />
			<html:div class="paneBackgroundBL" />
			<html:div class="paneBackgroundTitle" style="background-color: {$color};" />
			<html:div class="paneBackgroundTR" />
			<html:div class="paneBackgroundTL" />
			

		</html:div>
	</xsl:template>
	
	
	<f:function name="printOpenings">

		<f:param name="zui" />
		<f:param name="panelLayer" />
		<f:param name="width" />
		<f:param name="height" />
		<f:derived name="childZuis" from="zui">
			<get what="childZuis" />
		</f:derived>
		<f:derived name="openZuis" from="zui">
			<get what="childZuis" />
			<filter>
				<get what="minimized" />
				<equals>
					<start>
						<f:bool value="false" />
					</start>
				</equals>
			</filter>
		</f:derived>
		<f:derived name="leftChildInView" from="zui">
			<get what="leftChildInView" />
		</f:derived>
		
		
		<xsl:template>
			<xsl:variable name="spacing" select="10" />
			<xsl:variable name="padding" select="14" />
			<xsl:variable name="w" select="$width/@value - $padding * 2" />
			<xsl:variable name="h" select="$height/@value - $padding * 2" />
			
			<xsl:variable name="count" select="count($openZuis/*)" />
			<xsl:variable name="childWidth" select="floor(($w - $spacing * (2 - 1)) div 2)" />
			
			<xsl:variable name="taskBarChildWidth" select="150" />
			<html:div>
				
				<!--><xsl:for-each select="$openZuis/*">
					<html:div left="{$padding + count(preceding-sibling::*) * ($childWidth + $spacing)}" top="{$padding}">
						<f:thunk url="graphics/dropShadow.xml">
							<f:with-param name="width"><f:number value="{$childWidth}" /></f:with-param>
							<f:with-param name="height"><f:number value="{$h}" /></f:with-param>
							<f:with-param name="offsetX"><f:number value="0" /></f:with-param>
							<f:with-param name="offsetY"><f:number value="2" /></f:with-param>
							<f:with-param name="blurAmount"><f:number value="5" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:for-each>-->

				<xsl:variable name="taskBarHeight" select="40" />

				
				<!-- <f:consolelog msg="printing open zuis" count="{count($openZuis/*)}" /> -->
				
				<xsl:for-each select="$openZuis/*">
					<html:div left="{$padding + (count(preceding-sibling::*) - ($leftChildInView/@value)) * ($childWidth + $spacing)}" top="{$padding}" f:identifier="{@id}">
						<f:thunk url="zui.xml">
							<f:with-param name="zui" value-id="{./@id}" />
							<f:with-param name="panelLayer" value-id="{$panelLayer/@id}" />
							<f:with-param name="width"><f:number value="{$childWidth}" /></f:with-param>
							<f:with-param name="height"><f:number value="{$h - $taskBarHeight}" /></f:with-param>
						</f:thunk>
					</html:div>
				</xsl:for-each>
				
				<html:div>
					<html:div top="{2 * $padding + $h - $taskBarHeight}" left="{$padding}" width = "{$w}" height= "{$taskBarHeight - $padding}" >
						<html:div class="taskbarBackgroundRight"/>
						<html:div class="taskbarBackgroundLeft" />
						
						<xsl:for-each select="$childZuis/*">
							<html:div style="position:absolute; left: {$padding + count(preceding-sibling::*) * ($taskBarChildWidth + $spacing)}px; top: 5px;">
								<f:binding url="bindings/taskbar.xml">
									<f:with-param name="zui" value-id="{./@id}" />
								</f:binding>
								<f:button name="minimize" />

								<f:thunk name="printZuiContent">
									<f:with-param name="zui" value-id="{./@id}" />
								</f:thunk>
							</html:div>
						</xsl:for-each>
					</html:div>

				</html:div>
				
				<html:div>
					<f:binding url="bindings/scrollOpening.xml">
						<f:with-param name="count"><f:number value="{$count}" /></f:with-param>
						<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
						<f:with-param name="leftChildInView"><xsl:copy-of select="$leftChildInView" /></f:with-param>
					</f:binding>
					<html:div class="addButton" left="{$padding}" top="{$h div 2 - 12}" width="25" height="25">
						<f:button name="left" />
					</html:div>
					<html:div class="addButton" left="{$w - $padding}" top="{$h div 2 - 12}" width="25" height="25">
						<f:button name="right" />					
					</html:div>
				</html:div>
				
			</html:div>
		</xsl:template>
		

	</f:function>

	<f:function name="printZuiContent">
		<f:param name="zui" />
		<f:derived name="focus" from="zui">
			<get what="focus" />
		</f:derived>
		
		<xsl:template>
			<html:div>
				<f:thunk url="printContent.xml">
					<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
					<f:with-param name="style"><f:string value="inline" /></f:with-param>
				</f:thunk>
			</html:div>
		</xsl:template>
	</f:function>
	
	
</f:function>