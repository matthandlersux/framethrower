<f:function
	xmlns:f="http://www.filmsfolded.com/xsl/ui"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:html="http://www.w3.org/1999/xhtml"
	xmlns:svg="http://www.w3.org/2000/svg">

	<f:param name="zui" />
	<f:param name="width" />
	<f:param name="height" />
	<f:param name="panelLayer" />
	<f:param name="addPanel" />
	
	<f:derived name="focus" from="zui">
		<f:get what="focus" />
	</f:derived>
	<f:derived name="focusType" from="focus">
		<f:gettype />
	</f:derived>
	<f:derived name="maximizedChild" from="zui">
		<f:get what="maximizedChild" />
	</f:derived>
	<f:derived name="properties" from="zui">
		<f:get what="properties" />
	</f:derived>
	
	<xsl:template>
		<xsl:variable name="w" select="$width/@value" />
		<xsl:variable name="h" select="$height/@value" />
		
		<xsl:variable name="titleBarHeight" select="29" />
		
		<xsl:variable name="childrenSidebarExpandedWidth" select="190" />
		<xsl:variable name="childrenSidebarCollapsedWidth" select="19" />
		<xsl:variable name="childrenSidebarSearchHeight" select="47" />
		<xsl:variable name="childrenSidebarAddHeight" select="30" />
		
		<html:div class="zui" left="0" top="0" width="{$w}" height="{$h}">
			<f:binding url="bindings/zui.xml">
				<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
				<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
			</f:binding>
			
			<xsl:call-template name="paneBackground">
				<xsl:with-param name="color">
					<xsl:choose>
						<xsl:when test="$focusType/@value='kernel.situation'">#0ae</xsl:when>
						<xsl:otherwise>#9e2</xsl:otherwise>
					</xsl:choose>
				</xsl:with-param>
			</xsl:call-template>
			
			<html:div class="zuiTitle" left="0" top="0" width="{$w}" height="{$titleBarHeight}">
				<f:button name="titlebar" />
				<f:thunk url="printContent.xml">
					<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
					<f:with-param name="style"><f:string value="title" /></f:with-param>
				</f:thunk>
				<html:span style="margin-left:15px;" />
				<html:span style="position: absolute; left: 20%; top: 3px;" >
					<xsl:choose>
						<xsl:when test="$focusType/@value='kernel.situation'">
							<xsl:choose>
								<xsl:when test="$properties/@view='situation'">
									<html:span>
										<f:button name="situationView" />
										<html:div class="viewSituationSelected" />
									</html:span>
									<html:span>
										<f:button name="objectView" />
										<html:div class="viewInfons" />
									</html:span>
									<html:span>
										<f:button name="situationView" />
										<html:div class="viewInfonsAbout" />
									</html:span>
								</xsl:when>
								<xsl:otherwise>
									<html:span>
										<f:button name="situationView" />
										<html:div class="viewSituation" />
									</html:span>
									<html:span>
										<f:button name="objectView" />
										<html:div class="viewInfonsSelected" />
									</html:span>
									<html:span>
										<f:button name="situationView" />
										<html:div class="viewInfonsAbout" />
									</html:span>
								</xsl:otherwise>
							</xsl:choose>
						</xsl:when>
						<xsl:otherwise>
	
						</xsl:otherwise>
					</xsl:choose>
					<html:span style="margin-left: 45px">
						<f:button name="correspondSidebar" />
						<html:div class="viewCorresponds" />
					</html:span>
				</html:span>
				<html:span>
					<f:button name="minimize" />
					<html:div class="minimize" />
				</html:span>
				<html:span>
					<f:button name="maximize" />
					<html:div class="maximize" />
				</html:span>
				<html:span>
					<f:button name="close" />
					<html:div class="close" />
				</html:span>
			</html:div>
			
			<html:div class="zuiContent" left="0" top="{$titleBarHeight}" width="{$w}" height="{$h - $titleBarHeight}">
				<xsl:choose>
					<xsl:when test="$maximizedChild">
						<!-- This needs to be layed out properly... -->
						<xsl:variable name="openingWidth" select="$w" />
						<xsl:variable name="openingHeight" select="$h - $titleBarHeight" />
						
						<html:div class="zuiChildren" f:identifier="children" left="0" top="0" width="{$openingWidth}" height="{$openingHeight}">
							<html:div>
								<html:div f:identifier="opening" class="zuiOpening" left="0" top="0" width="{$openingWidth}" height="{$openingHeight}">
									<html:div f:identifier="{$maximizedChild/@id}" left="0" top="0" width="{$openingWidth}" height="{$openingHeight}">
										<f:thunk url="zui.xml">
											<f:with-param name="zui"><xsl:copy-of select="$maximizedChild" /></f:with-param>
											<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
											<f:with-param name="width"><f:number value="{$openingWidth}" /></f:with-param>
											<f:with-param name="height"><f:number value="{$openingHeight}" /></f:with-param>
										</f:thunk>
									</html:div>
								</html:div>
							</html:div>
						</html:div>
					</xsl:when>
					<xsl:when test="$properties/@view='situation' and $focusType/@value='kernel.situation'">
						<xsl:variable name="childrenSidebarWidth" select="$properties/@childrenSidebar * $childrenSidebarExpandedWidth + (1 - $properties/@childrenSidebar) * $childrenSidebarCollapsedWidth" />
						<html:div class="zuiChildrenSidebar" f:identifier="sidebar" left="0" top="0" width="{$childrenSidebarWidth}" height="{$h - $titleBarHeight}">
							<xsl:choose>
								<xsl:when test="$properties/@childrenSidebar='1'">
									<html:div style="width: 15px; position: absolute; right: 2px; top: 6px;">
										<f:button name="childrenSidebar" />
										<html:div class="childViewClose" />
									</html:div>
									<html:div class="zuiChildrenSidebarSearch" left="0" top="0" width="{$childrenSidebarWidth - 17}" height="{$childrenSidebarSearchHeight}">
										<html:div class="searchChildL" />
										<html:div class="searchChildR" />
										<html:div class="buttonContent">
											<html:span>search:</html:span>
											<html:input />
										</html:div>
									</html:div>
									<html:div class="zuiChildrenSidebarList" left="0" top="{$childrenSidebarSearchHeight}" width="{$childrenSidebarWidth}" height="{$h - $titleBarHeight - $childrenSidebarSearchHeight - $childrenSidebarAddHeight}">
										<f:thunk url="childrenSidebar.xml">
											<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
											<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
											<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
											<f:with-param name="addPanel"><xsl:copy-of select="$addPanel" /></f:with-param>
										</f:thunk>
									</html:div>

									<html:div class="zuiChildrenSidebarAdd" left="0" top="{$h - $titleBarHeight - $childrenSidebarAddHeight}" width="{$childrenSidebarWidth}" height="{$childrenSidebarAddHeight}">
										<html:div class="whiteButton" style="position: relative; width: 90%; height: 18px; top:5px; margin: auto auto; text-align: center;">
											<f:button name="addChild" />
											<html:div class="whiteButtonRight" />
											<html:div class="whiteButtonLeft" />
											<html:div class="buttonContent" style="text-align:center; color: #fff;">
												+ Add Item
											</html:div>
										</html:div>
									</html:div>
								</xsl:when>
								<xsl:otherwise>
									<html:div style="width: 15px; position: absolute; right: 2px; top: 6px;">
										<f:button name="childrenSidebar" />
										<html:div class="childViewOpen" />
									</html:div>
								</xsl:otherwise>
							</xsl:choose>
						</html:div>

						<!-- <xsl:variable name="correspondSidebarWidth" select="$properties/@correspondSidebar * $childrenSidebarExpandedWidth" />
						<xsl:if test="$properties/@correspondSidebar='1'">
							<html:div class="zuiChildrenSidebar" left="{$padding + $childrenSidebarWidth}" top="{$titleBarHeight}" width="{$correspondSidebarWidth}" height="{$height/@value - $titleBarHeight - $padding}">
								<f:thunk url="correspondSidebar.xml">
									<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
									<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								</f:thunk>
							</html:div>
							<html:div class="addButton" left="{$padding + $childrenSidebarWidth}" top="{$height/@value - $padding - 26}" width="{$correspondSidebarWidth}" height="26">
								<f:button name="addCorresponds" />
							</html:div>
						</xsl:if> -->

						<xsl:variable name="childrenWidth" select="$w - $childrenSidebarWidth" />
						<xsl:variable name="childrenHeight" select="$h - $titleBarHeight" />

						<html:div class="zuiChildren" f:identifier="children" left="{$childrenSidebarWidth}" top="0" width="{$childrenWidth}" height="{$childrenHeight}">
							<f:thunk name="printChildren">
								<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
								<f:with-param name="panelLayer"><xsl:copy-of select="$panelLayer" /></f:with-param>
								<f:with-param name="width"><f:number value="{$childrenWidth}" /></f:with-param>
								<f:with-param name="height"><f:number value="{$childrenHeight}" /></f:with-param>
							</f:thunk>
						</html:div>
					</xsl:when>
					<xsl:otherwise>
						<!-- <xsl:variable name="correspondSidebarWidth" select="$properties/@correspondSidebar * $childrenSidebarExpandedWidth" />
						<xsl:if test="$properties/@correspondSidebar='1'">
							<html:div class="zuiChildrenSidebar" left="{$padding}" top="{$titleBarHeight}" width="{$correspondSidebarWidth}" height="{$height/@value - $titleBarHeight - $padding}">
								<f:thunk url="correspondSidebar.xml">
									<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
									<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								</f:thunk>
							</html:div>
							<html:div class="addButton" left="{$padding}" top="{$height/@value - $padding - 26}" width="{$correspondSidebarWidth}" height="26">
								<f:button name="addCorresponds" />
							</html:div>
						</xsl:if>	 -->				

						<f:thunk url="objectView.xml">
							<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
						</f:thunk>
						<html:div style="margin-left:15px">
							<f:button name="addInfon" />
							Add Infon
						</html:div>
					</xsl:otherwise>
				</xsl:choose>
			</html:div>

		</html:div>
	</xsl:template>
	
	<xsl:template name="paneBackground">
		<xsl:param name="color" />
		<html:div style="position:absolute; top:0px; left:0px; width:100%; height:100%;">
			<html:div class="paneBackgroundBR" />
			<html:div class="paneBackgroundBL" />
			<html:div class="paneBackgroundTitle" style="background-color: {$color};" />
			<html:div class="paneBackgroundTR" />
			<html:div class="paneBackgroundTL" />
		</html:div>
	</xsl:template>
	
	
	<f:function name="printChildren">
		<f:param name="zui" />
		<f:param name="panelLayer" />
		<f:param name="width" />
		<f:param name="height" />
		
		<f:derived name="childZuisMinimized" from="zui">
			<f:get what="childZuis" />
			<buildassoc what="minimized" />	
		</f:derived>
		
		<f:derived name="leftChildInView" from="zui">
			<f:get what="leftChildInView" />
		</f:derived>
		
		<f:derived name="leftRailChild" from="zui">
			<f:get what="leftRailChild" />
		</f:derived>
		
		<xsl:template>
			<xsl:variable name="marginRight" select="8" />
			<xsl:variable name="marginTop" select="6" />
			<xsl:variable name="marginLeft" select="0" />
			<xsl:variable name="marginBetween" select="4" />
			<xsl:variable name="marginBottom" select="4" />
			
			<xsl:variable name="taskBarHeight" select="24" />
			<xsl:variable name="railScrollWidth" select="18" />
			
			<xsl:variable name="spacing" select="10" />
			<xsl:variable name="padding" select="14" />
			
			<xsl:variable name="taskBarChildWidth" select="150" />
			
			<xsl:variable name="w" select="$width/@value - $marginLeft - $marginRight" />
			<xsl:variable name="h" select="$height/@value - $marginTop - $marginBetween - $taskBarHeight - $marginBottom - $padding * 2" />
			
			<xsl:variable name="count" select="count($childZuisMinimized/*)" />
			<xsl:variable name="openZuis" select="$childZuisMinimized/f:pair[f:value/f:bool/@value = 'false']" />
			<xsl:variable name="openZuiCount" select="count($openZuis)" />

			<xsl:variable name="childWindow">
				<xsl:choose>
					<xsl:when test="$openZuiCount = 1 or $openZuiCount = 0">
						1
					</xsl:when>
					<xsl:otherwise>
						2
					</xsl:otherwise>
				</xsl:choose>
			</xsl:variable>
			
			<xsl:variable name="childWidth" select="floor(($w - 2 * $padding - $spacing * ($childWindow - 1)) div $childWindow)" />
			
			<html:div>
				<!-- <f:consolelog msg="printing open zuis" count="{count($openZuis/*)}" /> -->
				
				<html:div class="zuiOpening" f:identifier="opening" left="{$marginLeft}" top="{$marginTop}" width="{$w}" height="{$h + $padding * 2}">
					<xsl:for-each select="$openZuis">
						<html:div left="{$padding + (position() - 1 - ($leftChildInView/@value)) * ($childWidth + $spacing)}" top="{$padding}" f:identifier="{./f:key/f:ob/@id}">
							<f:thunk url="zui.xml">
								<f:with-param name="zui" value-id="{./f:key/f:ob/@id}" />
								<f:with-param name="panelLayer" value-id="{$panelLayer/@id}" />
								<f:with-param name="width"><f:number value="{$childWidth}" /></f:with-param>
								<f:with-param name="height"><f:number value="{$h}" /></f:with-param>
							</f:thunk>
						</html:div>
					</xsl:for-each>
				</html:div>
				
				
				<html:div class="zuiRail" f:identifier="rail" left="{$marginLeft + $railScrollWidth}" top="{$height/@value - $marginBottom - $taskBarHeight}" width="{$w - 2 * $railScrollWidth}" height="{$taskBarHeight}">
					<html:div style="position:absolute; top:0px; left:0px; width:100%; height:100%;">
						<html:div class="taskbarBackgroundRight"/>
						<html:div class="taskbarBackgroundLeft" />
					</html:div>
						
					<xsl:for-each select="$childZuisMinimized/*">
						<html:div left="{(count(preceding-sibling::*) - $leftRailChild/@value) * ($taskBarChildWidth)}" top="2" width="{$taskBarChildWidth}" f:identifier="{./f:key/f:ob/@id}">

							<f:thunk name="railButton">
								<f:with-param name="zui" value-id="{./f:key/f:ob/@id}" />
									<xsl:variable name="scrollOffset" select="count(preceding-sibling::*[f:value/f:bool/@value = 'false']) - $leftChildInView/@value" />
								<f:with-param name="inView">
									<f:bool value="{($scrollOffset &gt;= 0) and ($scrollOffset &lt; $childWindow)}" />
								</f:with-param>
								<f:with-param name="leftChildInView"><f:number value="{$leftChildInView/@value}" /></f:with-param>
								<f:with-param name="openZuiCount"><f:number value="{$openZuiCount}" /></f:with-param>
							</f:thunk>
						</html:div>
					</xsl:for-each>
				</html:div>

				<html:div f:identifier="scrollRail" left="{$marginLeft}" top="{$height/@value - $marginBottom - $taskBarHeight}" width="{$w}">
					<f:binding url="bindings/scrollRail.xml">
						<f:with-param name="count"><f:number value="{$count}" /></f:with-param>
						<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
						<f:with-param name="leftRailChild"><xsl:copy-of select="$leftRailChild" /></f:with-param>
					</f:binding>
					<html:div class="railScrollLeft" left="{4}" top="5">
						<f:button name="left" />
					</html:div>
					<html:div class="railScrollRight" left="{$w - $railScrollWidth + 4}" top="5">
						<f:button name="right" />
					</html:div>
				</html:div>
				
				<html:div f:identifier="scrollOpening">
					<f:binding url="bindings/scrollOpening.xml">
						<f:with-param name="count"><f:number value="{$openZuiCount}" /></f:with-param>
						<f:with-param name="leftChildInView"><xsl:copy-of select="$leftChildInView" /></f:with-param>
						<f:with-param name="zui"><xsl:copy-of select="$zui" /></f:with-param>
					</f:binding>
					<html:div class="pageLeft" left="{$padding}" top="{$h div 2 - 15}"> 
						<f:button name="left" /> 
					</html:div> 
					<html:div class="pageRight" left="{$w - 38 - $padding}" top="{$h div 2 - 15}">
						<f:button name="right" />
					</html:div>
				</html:div>
				
			</html:div>
		</xsl:template>
		

	</f:function>

	<f:function name="railButton">
		<f:param name="zui" />
		<f:derived name="focus" from="zui">
			<f:get what="focus" />
		</f:derived>
		<f:derived name="minimized" from="zui">
			<f:get what="minimized" />
		</f:derived>
		<f:param name="inView" />
		<f:param name="openZuiCount" />
		
		
		<xsl:template>
			<html:div class="greyButton">
				<f:binding url="bindings/taskbar.xml">
					<f:with-param name="zui" value-id="{$zui/@id}" />
					<f:with-param name="openZuiCount"><f:number value="{$openZuiCount/@value}" /></f:with-param>
				</f:binding>
				
				<xsl:choose>
					<xsl:when test="$minimized/@value = 'true'">
						<f:button name="restore" />
						<html:div class="greyButtonMinimizedRight" style="color: #fff;">
							<f:thunk url="printContent.xml">
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								<f:with-param name="style"><f:string value="inline" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="greyButtonMinimizedLeft" />
					</xsl:when>
					<xsl:when test="$inView/@value = 'true'">
						<f:button name="minimize" />						
						<html:div class="greyButtonViewingRight" style="color: #fff;">
							<f:thunk url="printContent.xml">
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								<f:with-param name="style"><f:string value="title" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="greyButtonViewingLeft" />
					</xsl:when>
					<xsl:otherwise>
						<f:button name="center" />						
						<html:div class="greyButtonRight" style="color: #fff;">
							<f:thunk url="printContent.xml">
								<f:with-param name="focus"><xsl:copy-of select="$focus" /></f:with-param>
								<f:with-param name="style"><f:string value="inline" /></f:with-param>
							</f:thunk>
						</html:div>
						<html:div class="greyButtonLeft" />
					</xsl:otherwise>
				</xsl:choose>
				
			</html:div>
		</xsl:template>
	</f:function>
	
	
</f:function>