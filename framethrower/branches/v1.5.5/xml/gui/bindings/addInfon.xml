<f:binding
	xmlns:f="http://www.filmsfolded.com/xsl/ui"
	xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
	
	<f:transaction name="Close" event="click" button="close">
		<f:param name="panelLayer" />
		<f:param name="addPanel" />
		<f:derived name="infonArgs" from="addPanel">
			<f:get what="infonArgs" />
		</f:derived>

		<xsl:template>
			<f:transaction>
				<f:intact with-id="{$panelLayer/@id}" prop="addInfon" action="set">
					<f:with-param>
						<f:bool value="false" />
					</f:with-param>
				</f:intact>
				<f:intact with-id="{$addPanel/@id}" prop="selectedRelation" action="set">
					<f:with-param />
				</f:intact>

				<xsl:for-each select="$infonArgs/*">
					<f:intact with-id="{$addPanel/@id}" prop="infonArgs" action="remove">
						<f:with-param>
							<xsl:copy-of select="./f:key/*" />
						</f:with-param>
					</f:intact>
				</xsl:for-each>
			</f:transaction>
		</xsl:template>
		
	</f:transaction>
	
	
	
	<f:transaction name="DropDown" event="click" button="dropDown">
		<f:param name="addPanel" />
		
		<f:derived name="expanded" from="addPanel">
			<f:get what="expanded" />
		</f:derived>
		

		<xsl:template>
			<f:transaction>
				<f:intact with-id="{$addPanel/@id}" prop="expanded" action="set">
					<f:with-param>
						<xsl:choose>
							<xsl:when test="$expanded/@value = 'true'">
								<f:bool value="false" />
							</xsl:when>
							<xsl:otherwise>
								<f:bool value="true" />
							</xsl:otherwise>
						</xsl:choose>
					</f:with-param>
				</f:intact>
			</f:transaction>
		</xsl:template>
		
	</f:transaction>


	
	<f:transaction name="BrowseArg" event="click" button="browseArg">
		<f:param name="argNum" />
		<f:param name="panelLayer" />
		
		<xsl:template>
			<f:transaction>
				<f:intact with-id="{$panelLayer/@id}" prop="selectArg" action="set">
					<f:with-param>
						<xsl:copy-of select="$argNum" />
					</f:with-param>
				</f:intact>
				<f:intact with-id="{$panelLayer/@id}" prop="addInfon" action="set">
					<f:with-param>
						<f:bool value="false" />
					</f:with-param>
				</f:intact>
			</f:transaction>
		</xsl:template>
		
	</f:transaction>




	
	<f:transaction name="Select" event="click" button="select">
		<f:param name="relation" />
		<f:param name="addPanel" />
		
		<xsl:template>
			<f:transaction>
				<f:intact with-id="{$addPanel/@id}" prop="selectedRelation" action="set">
					<f:with-param>
						<xsl:copy-of select="$relation" />
					</f:with-param>
				</f:intact>
				<f:perform name="DropDown">
					<f:with-param name="addPanel" value-id="{$addPanel/@id}" />
				</f:perform>
			</f:transaction>
		</xsl:template>
		
	</f:transaction>


	
	<f:transaction name="SelectArg" event="click" button="selectArg">
		<f:param name="addFocus" />
		<f:param name="panelLayer" />
		<f:param name="addPanel" />
		
		<f:derived name="selectArg" from="panelLayer">
			<f:get what="selectArg" />
		</f:derived>

		<xsl:template>
			<f:transaction>
				<f:intact with-id="{$addPanel/@id}" prop="infonArgs" action="set">
					<f:with-param>
						<xsl:copy-of select="$selectArg" />
					</f:with-param>
					<f:with-param>
						<xsl:copy-of select="$addFocus" />
					</f:with-param>
				</f:intact>
				<f:intact with-id="{$panelLayer/@id}" prop="selectArg" action="set">
					<f:with-param />
				</f:intact>				
				<f:intact with-id="{$panelLayer/@id}" prop="addInfon" action="set">
					<f:with-param>
						<f:bool value="true" />
					</f:with-param>
				</f:intact>
			</f:transaction>
		</xsl:template>		
	</f:transaction>



	<f:transaction name="Submit" event="click" button="submit">
		<f:param name="panelLayer" />
		<f:param name="addPanel" />
		<f:derived name="infonArgs" from="addPanel">
			<f:get what="infonArgs" />
		</f:derived>
		<f:derived name="selectedRelation" from="addPanel">
			<f:get what="selectedRelation" />
		</f:derived>
		<f:derived name="selectedRelationContent" from="selectedRelation">
			<f:get what="content" />
		</f:derived>
		<f:derived name="addFocus" from="panelLayer">
			<f:get what="addFocus" />
		</f:derived>
		<f:derived name="parentSituation" from="addFocus">
			<f:get what="parentSituation" />
		</f:derived>
		
		<xsl:template>
			<f:transaction>
				<f:perform absurl="xml/api/makeInfon.xml">
					<f:with-param name="parentSituation" value-id="{$parentSituation/@id}" />
					<f:with-param name="relation" value-id="{$selectedRelation/@id}" />
					<f:with-param name="arcs">
						<f:assoc>
							<xsl:for-each select="$selectedRelationContent/pseudo/*">
								<xsl:if test="self::role">
									<xsl:variable name="index" select="count(preceding-sibling::role)" />
									<xsl:variable name="arg" select="$infonArgs/*[f:key/f:number/@value = ($index)]/f:value/*" />
									<f:pair>
										<f:key><f:string value="{@role}" /></f:key>
										<f:value><xsl:copy-of select="$arg"/></f:value>
									</f:pair>
								</xsl:if>
							</xsl:for-each>
						</f:assoc>
					</f:with-param>
				</f:perform>
				
				<f:perform name="Close">
					<f:with-param name="panelLayer" value-id="{$panelLayer/@id}" />
					<f:with-param name="addPanel" value-id="{$addPanel/@id}" />
				</f:perform>
			</f:transaction>
		</xsl:template>
		
	</f:transaction>

	
</f:binding>



